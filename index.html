<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸ“ˆ Gold-Silber-Ratio</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#facc15">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gold/Silber">

  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Chart.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script> 

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #fffbeb 0%, #fbbf24 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    h1 {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
      color: white;
      font-size: 2rem;
      font-weight: 600;
    }
    .chart-wrapper {
      padding: 30px;
      position: relative;
      height: 500px;
    }
    canvas {
      max-width: 100%;
      height: auto;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #777;
      font-size: 1.1rem;
    }
    .info-box {
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      padding: 20px;
      margin: 20px 30px;
      border-radius: 8px;
    }
    .info-box h3 {
      color: #f59e0b;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .info-box p {
      color: #92400e;
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .current-ratio {
      text-align: center;
      padding: 20px;
      background: #fbbf24;
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      flex-wrap: wrap;
    }
    .controls button {
      padding: 10px 20px;
      border: 2px solid #f59e0b;
      background: white;
      color: #f59e0b;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .controls button.active,
    .controls button:hover {
      background: #f59e0b;
      color: white;
    }
    .status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .status-live {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .status-cached {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .status-error {
      background: #fecaca;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; padding: 20px; }
      .chart-wrapper { padding: 20px; height: 400px; }
      .info-box { margin: 15px 20px; }
      .controls { padding: 15px 10px; }
      .controls button { padding: 8px 16px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“ˆ Gold-Silber-Ratio (Echte Marktdaten)</h1>
    
    <div class="status-indicator" id="statusIndicator">
      ðŸ”„ Lade Daten...
    </div>
    
    <div class="current-ratio" id="currentRatio">
      Aktuelles VerhÃ¤ltnis wird geladen...
    </div>

    <div class="controls">
      <button onclick="setTimeframe('1Y')" id="btn-1Y" class="active">1 Jahr</button>
      <button onclick="setTimeframe('5Y')" id="btn-5Y">5 Jahre</button>
      <button onclick="setTimeframe('10Y')" id="btn-10Y">10 Jahre</button>
    </div>

    <div class="chart-wrapper">
      <canvas id="ratioChart"></canvas>
    </div>
    
    <div class="loading" id="loading">Marktdaten werden geladen...</div>
    
    <div class="info-box">
      <h3>ðŸ“Š Interpretation der Gold-Silber-Ratio</h3>
      <p><strong>ðŸŸ¢ Ratio unter 40:</strong> Gold relativ gÃ¼nstig - guter Kaufzeitpunkt fÃ¼r Gold</p>
      <p><strong>Ratio 40-60:</strong> Ausgewogenes VerhÃ¤ltnis - normale Marktbedingungen</p>
      <p><strong>Ratio 60-80:</strong> Gold wird teurer - Silber wird attraktiver</p>
      <p><strong>ðŸ”´ Ratio Ã¼ber 80:</strong> Silber sehr gÃ¼nstig - guter Kaufzeitpunkt fÃ¼r Silber</p>
      <p><em>Daten basieren auf Alpha Vantage ETF-Preisen (GLD/SLV). Historisch schwankte die Ratio zwischen 15 und 100+.</em></p>
    </div>
  </div>

  <script>
    const ctx = document.getElementById('ratioChart').getContext('2d');
    let ratioChart;
    let currentTimeframe = '1Y';
    let cachedData = {};

    // Cache-SchlÃ¼ssel
    const CACHE_KEY = 'gold_silver_data_real';
    const CACHE_TIMESTAMP_KEY = 'gold_silver_timestamp_real';
    const CACHE_DURATION = 30 * 60 * 1000; // 30 Minuten Cache fÃ¼r echte Daten

    // Status-Updates
    function updateStatus(message, type = 'loading') {
      const indicator = document.getElementById('statusIndicator');
      indicator.textContent = message;
      indicator.className = `status-indicator status-${type}`;
    }

    // In-Memory Cache fÃ¼r diese Session
    let memoryCache = null;
    let cacheTimestamp = null;

    function getCachedData() {
      if (cacheTimestamp && memoryCache) {
        const age = Date.now() - cacheTimestamp;
        if (age < CACHE_DURATION) {
          return memoryCache;
        }
      }
      return null;
    }

    function setCachedData(data) {
      memoryCache = data;
      cacheTimestamp = Date.now();
    }

    // Echte Daten von Alpha Vantage API abrufen
    async function fetchRealMetalsPrices() {
      updateStatus('Lade aktuelle Marktdaten...', 'loading');
      
      try {
        const alphaVantageKey = '7KGX8G9VGRJ5QJ71';
        
        // Parallele Abfrage von Gold- und Silberpreisen
        const [goldResponse, silverResponse] = await Promise.all([
          fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=GLD&apikey=${alphaVantageKey}`),
          fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=SLV&apikey=${alphaVantageKey}`)
        ]);
        
        const goldData = await goldResponse.json();
        const silverData = await silverResponse.json();
        
        // PrÃ¼fen auf API-Limits oder Fehler
        if (goldData['Error Message'] || silverData['Error Message']) {
          throw new Error('API-Limit erreicht oder Fehler');
        }
        
        if (goldData['Note'] || silverData['Note']) {
          throw new Error('API-Aufruf-Limit erreicht');
        }
        
        // Daten verarbeiten
        const processedData = processAlphaVantageData(goldData, silverData);
        
        updateStatus('Alpha Vantage Daten geladen', 'live');
        return processedData;
        
      } catch (error) {
        console.error('Alpha Vantage API-Fehler:', error);
        updateStatus('Fallback: Realistische Demo-Daten', 'cached');
        
        // Fallback auf realistische Demo-Daten
        return generateRealisticDemoData();
      }
    }
    
    // Alpha Vantage Daten verarbeiten
    function processAlphaVantageData(goldData, silverData) {
      const goldTimeSeries = goldData['Time Series (Daily)'];
      const silverTimeSeries = silverData['Time Series (Daily)'];
      
      if (!goldTimeSeries || !silverTimeSeries) {
        throw new Error('Keine Zeitreihendaten verfÃ¼gbar');
      }
      
      const goldDates = Object.keys(goldTimeSeries).sort();
      const silverDates = Object.keys(silverTimeSeries).sort();
      
      // Gemeinsame Daten finden
      const commonDates = goldDates.filter(date => silverDates.includes(date));
      const days = getDaysForTimeframe(currentTimeframe);
      const recentDates = commonDates.slice(-days);
      
      const historicalData = recentDates.map(date => {
        const goldClose = parseFloat(goldTimeSeries[date]['4. close']);
        const silverClose = parseFloat(silverTimeSeries[date]['4. close']);
        
        // ETF-Preise in ungefÃ¤hre Spot-Preise umwandeln
        // GLD reprÃ¤sentiert etwa 1/10 Unze Gold, SLV etwa 1 Unze Silber
        const approxGoldPrice = goldClose * 10;
        const approxSilverPrice = silverClose;
        
        const ratio = approxGoldPrice / approxSilverPrice;
        
        return {
          date: date,
          ratio: ratio,
          gold: approxGoldPrice,
          silver: approxSilverPrice
        };
      });
      
      const latest = historicalData[historicalData.length - 1];
      
      return {
        historical: historicalData,
        current: {
          gold: latest.gold,
          silver: latest.silver,
          ratio: latest.ratio
        }
      };
    }

    async function generateHistoricalFromCurrent(currentPrices) {
      const goldPrice = currentPrices.gold || 2000;
      const silverPrice = currentPrices.silver || 25;
      const currentRatio = goldPrice / silverPrice;
      
      const data = [];
      const days = getDaysForTimeframe(currentTimeframe);
      const now = new Date();
      
      for (let i = 0; i < days; i++) {
        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const dayOffset = i / 365;
        
        // Realistische Schwankungen basierend auf historischen Mustern
        const volatility = 0.02 + Math.sin(i * 0.1) * 0.01;
        const trend = Math.sin(dayOffset * 2 * Math.PI) * 0.05;
        const noise = (Math.random() - 0.5) * volatility;
        
        const ratioMultiplier = 1 + trend + noise;
        const dailyRatio = currentRatio * ratioMultiplier;
        
        data.unshift({
          date: date.toISOString().split('T')[0],
          ratio: Math.max(30, Math.min(100, dailyRatio))
        });
      }
      
      return {
        historical: data,
        current: {
          gold: goldPrice,
          silver: silverPrice,
          ratio: currentRatio
        }
      };
    }

    function generateRealisticDemoData() {
      const data = [];
      const days = getDaysForTimeframe(currentTimeframe);
      const now = new Date();
      
      // Aktuelle realistische Preise (NÃ¤herungswerte)
      const baseGoldPrice = 2050;
      const baseSilverPrice = 25;
      const baseRatio = baseGoldPrice / baseSilverPrice;
      
      for (let i = 0; i < days; i++) {
        const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
        const dayOffset = i / 365;
        
        // Realistische Marktzyklen und VolatilitÃ¤t
        const marketCycle = Math.sin(dayOffset * 2 * Math.PI) * 8;
        const volatility = (Math.random() - 0.5) * 4;
        const trend = -dayOffset * 2; // Leichter AbwÃ¤rts-trend Ã¼ber Zeit
        
        const ratio = baseRatio + marketCycle + volatility + trend;
        
        data.unshift({
          date: date.toISOString().split('T')[0],
          ratio: Math.max(40, Math.min(95, ratio))
        });
      }
      
      return {
        historical: data,
        current: {
          gold: baseGoldPrice,
          silver: baseSilverPrice,
          ratio: baseRatio
        }
      };
    }

    function getDaysForTimeframe(timeframe) {
      const map = {
        '1Y': 365,
        '5Y': 1825,
        '10Y': 3650
      };
      return map[timeframe] || 365;
    }

    async function fetchData(useCache = true) {
      try {
        let data = null;
        
        if (useCache) {
          data = getCachedData();
          if (data) {
            updateStatus('Cache-Daten verwendet', 'cached');
          }
        }
        
        if (!data) {
          data = await fetchRealMetalsPrices();
          setCachedData(data);
        }

        cachedData = data;
        displayData(data);
        
      } catch (error) {
        console.error('Datenfehler:', error);
        updateStatus('Fehler beim Laden', 'error');
        document.getElementById('loading').textContent = `Fehler: ${error.message}`;
      }
    }

    function displayData(data) {
      const days = getDaysForTimeframe(currentTimeframe);
      let chartData = data.historical ? data.historical.slice(-days) : [];
      
      // Daten fÃ¼r den gewÃ¤hlten Zeitraum filtern
      if (currentTimeframe === '1Y') {
        chartData = chartData.filter((_, index) => index % 7 === 0); // WÃ¶chentliche Punkte
      } else if (currentTimeframe === '5Y') {
        chartData = chartData.filter((_, index) => index % 30 === 0); // Monatliche Punkte
      } else {
        chartData = chartData.filter((_, index) => index % 60 === 0); // Alle 2 Monate
      }
      
      if (chartData.length === 0) {
        document.getElementById('loading').textContent = 'Keine Daten verfÃ¼gbar';
        return;
      }

      const currentRatio = data.current ? data.current.ratio : chartData[chartData.length - 1].ratio;
      document.getElementById('currentRatio').textContent = 
        `Aktuelle Gold/Silber-Ratio: ${currentRatio.toFixed(2)}`;

      document.getElementById('loading').style.display = 'none';

      if (ratioChart) ratioChart.destroy();

      ratioChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(d => {
            const date = new Date(d.date);
            return currentTimeframe === '1Y' ? 
              date.toLocaleDateString('de-DE', { month: 'short', day: '2-digit' }) :
              date.toLocaleDateString('de-DE', { year: '2-digit', month: 'short' });
          }),
          datasets: [{
            label: 'Gold/Silber Ratio',
            data: chartData.map(d => d.ratio),
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            pointRadius: 1,
            pointHoverRadius: 6,
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              display: true,
              labels: {
                color: '#f59e0b',
                font: { size: 14 }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(245, 158, 11, 0.9)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: '#f59e0b',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const ratio = context.parsed.y;
                  let interpretation = '';
                  if (ratio < 40) interpretation = ' (ðŸŸ¢ Gold gÃ¼nstig!)';
                  else if (ratio < 60) interpretation = ' (Ausgewogen)';
                  else if (ratio < 80) interpretation = ' (Gold wird teurer)';
                  else interpretation = ' (ðŸ”´ Silber gÃ¼nstig!)';
                  
                  return `Ratio: ${ratio.toFixed(2)}${interpretation}`;
                }
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          scales: {
            x: {
              grid: {
                color: '#fffbeb'
              },
              ticks: {
                color: '#92400e',
                maxTicksLimit: 12
              }
            },
            y: {
              beginAtZero: false,
              min: 30,
              max: 100,
              grid: {
                color: (context) => {
                  if (Math.abs(context.tick.value - 40) < 1) {
                    return '#22c55e';
                  }
                  if (Math.abs(context.tick.value - 80) < 1) {
                    return '#ef4444';
                  }
                  return '#fffbeb';
                },
                lineWidth: (context) => {
                  if (Math.abs(context.tick.value - 40) < 1 || 
                      Math.abs(context.tick.value - 80) < 1) {
                    return 3;
                  }
                  return 1;
                }
              },
              ticks: {
                color: '#92400e',
                callback: function(value) {
                  if (value === 40) return 'ðŸŸ¢ 40';
                  if (value === 80) return 'ðŸ”´ 80'; 
                  return value.toFixed(0);
                }
              }
            }
          }
        }
      });
    }

    function setTimeframe(timeframe) {
      document.querySelectorAll('.controls button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`btn-${timeframe}`).classList.add('active');
      
      currentTimeframe = timeframe;
      
      if (cachedData && cachedData.historical) {
        displayData(cachedData);
      } else {
        fetchData();
      }
    }

    // Initial laden
    fetchData();
  </script>
</body>
</html>
